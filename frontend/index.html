<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åœ‹è€ƒé¡Œç·´ç¿’ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }
  </script>

  <div class="container py-4">
    <div class="mb-3 text-end">
      <span class="me-3 text-success">ğŸ‘¤ å·²ç™»å…¥ï¼š<strong id="currentUser"></strong></span>
      <a href="/history.html" class="btn btn-sm btn-outline-info me-2">ğŸ“– ä½œç­”ç´€éŒ„</a>
      <a href="/review.html" class="btn btn-sm btn-outline-warning me-2">âŒ éŒ¯é¡Œå†ç·´ç¿’</a>
      <button class="btn btn-sm btn-outline-danger" onclick="logout()">ç™»å‡º</button>
    </div>

    <h2 class="text-center mb-4">ğŸ©º é†«äº‹äººå“¡åœ‹è€ƒé¡Œç·´ç¿’ç³»çµ±</h2>

    <div class="card mb-4 p-3">
      <div class="row g-2 mb-2">
        <div class="col-md-4">
          <label class="form-label">é¸æ“‡é ˜åŸŸ</label>
          <select id="typeSelect" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">é¸æ“‡ç§‘ç›®</label>
          <select id="categorySelect" class="form-select" disabled></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">é¸æ“‡å¹´åº¦</label>
          <select id="yearSelect" class="form-select" disabled>
            <option selected disabled>è«‹é¸æ“‡</option>
          </select>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-md-4" id="countField" style="display: none;">
          <label class="form-label">éš¨æ©Ÿå‡ºé¡Œé¡Œæ•¸ï¼ˆå¯èª¿æ•´ï¼‰</label>
          <input type="number" id="questionCount" class="form-control" value="80" min="1" max="500">
        </div>
      </div>
      <div class="row g-2">
        <div class="col text-center">
          <button class="btn btn-primary" onclick="loadQuestions()">é–‹å§‹ç·´ç¿’</button>
        </div>
      </div>
    </div>

    <form id="quizForm" class="d-none">
      <div id="questionList"></div>
      <button type="submit" class="btn btn-success mt-4">é€å‡ºä½œç­”</button>
    </form>

    <div id="result" class="mt-4"></div>
  </div>

  <script>
    let questions = [];

    document.getElementById('currentUser').innerText = localStorage.getItem('username') || 'æœªçŸ¥ä½¿ç”¨è€…';

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      window.location.href = '/login.html';
    }

    async function fetchTypes() {
      const res = await fetch('/api/list-types');
      const data = await res.json();
      const typeSelect = document.getElementById('typeSelect');
      typeSelect.innerHTML = '<option selected disabled>è«‹é¸æ“‡</option>';
      for (const type in data) {
        typeSelect.innerHTML += `<option value="${type}">${type}</option>`;
      }

      typeSelect.onchange = () => {
        const selectedType = typeSelect.value;
        const categorySelect = document.getElementById('categorySelect');
        const yearSelect = document.getElementById('yearSelect');
        const countField = document.getElementById('countField');

        const categories = Object.keys(data[selectedType]);
        categorySelect.disabled = false;
        categorySelect.innerHTML = '<option selected disabled>è«‹é¸æ“‡</option>';
        categories.forEach(cat => {
          categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });

        categorySelect.onchange = () => {
          const years = data[selectedType][categorySelect.value];
          yearSelect.disabled = false;
          yearSelect.innerHTML = '<option selected disabled>è«‹é¸æ“‡</option>';
          years.sort((a, b) => parseInt(b) - parseInt(a));
          years.forEach(year => {
            yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
          });
          yearSelect.innerHTML += `<option value="random">éš¨æ©Ÿå‡ºé¡Œï¼ˆé è¨­ 80 é¡Œï¼‰</option>`;

          countField.style.display = 'none';
          yearSelect.onchange = () => {
            countField.style.display = (yearSelect.value === 'random') ? 'block' : 'none';
          };
        };
      };
    }

    async function loadQuestions() {
      const level = document.getElementById('typeSelect').value;
      const category = document.getElementById('categorySelect').value;
      const year = document.getElementById('yearSelect').value;
      const count = (year === 'random') ? parseInt(document.getElementById('questionCount').value || '80') : undefined;

      const payload = { level, category, year };
      if (count) payload.count = count;

      const res = await fetch('/api/load-questions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      questions = await res.json();
      // å°‡ filename æ”¾å…¥æ¯é¡Œä¸­
      questions.forEach(q => q.filename = `${year}_${level}_${category}.json`);
      displayQuestions(questions);
    }

    function displayQuestions(qList) {
      const quizForm = document.getElementById('quizForm');
      const questionList = document.getElementById('questionList');
      questionList.innerHTML = '';
      qList.forEach((q, i) => {
        questionList.innerHTML += `
          <div class="card p-3 mb-3">
            <p><strong>ç¬¬ ${i + 1} é¡Œï¼š</strong>${q.question}</p>
            ${['A', 'B', 'C', 'D'].map(opt => `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q${q.id}" value="${opt}" id="q${q.id}_${opt}">
                <label class="form-check-label" for="q${q.id}_${opt}">(${opt}) ${q.options[opt]}</label>
              </div>`).join('')}
            <div id="result-${q.id}" class="mt-2"></div>
          </div>
        `;
      });
      quizForm.classList.remove('d-none');
      document.getElementById('result').innerHTML = '';
    }

    document.getElementById('quizForm').onsubmit = async function(e) {
      e.preventDefault();
      const count = questions.length;
      const pointPerQuestion = 100 / count;
      let score = 0;
      const results = [];

      questions.forEach(q => {
        const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
        const userAns = selected ? selected.value : '';
        const resultDiv = document.getElementById(`result-${q.id}`);
        const correctAnswers = q.answer;
        let isCorrect = false;
        if (correctAnswers === null) isCorrect = true;
        else if (Array.isArray(correctAnswers)) isCorrect = correctAnswers.includes(userAns);
        else isCorrect = (userAns === correctAnswers);
        if (isCorrect) score += pointPerQuestion;

        results.push({
          question_id: q.id,
          correct: isCorrect,
          user_answer: userAns,
          question: q
        });

        resultDiv.innerHTML = isCorrect
          ? `<span class="text-success">âœ… æ­£ç¢º</span>`
          : `<span class="text-danger">âŒ ç­”éŒ¯ï¼Œæ­£ç¢ºç­”æ¡ˆï¼š${Array.isArray(correctAnswers) ? correctAnswers.join('ã€') : correctAnswers}</span>`;
      });

      document.getElementById('result').innerHTML = `<h4>ğŸ‰ ç¸½åˆ†ï¼š${score.toFixed(2)} åˆ†</h4>`;

      const token = localStorage.getItem('token');
      if (token) {
        fetch('/api/save-answers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ results })
        })
        .then(async res => {
          const json = await res.json().catch(() => ({}));
          console.log('ä¼ºæœå™¨å›æ‡‰ç‹€æ…‹:', res.status);
          console.log('ä¼ºæœå™¨å›æ‡‰å…§å®¹:', json);
        })
        .catch(err => {
          console.error('Fetch ç™¼ç”ŸéŒ¯èª¤:', err);
        });
      }
    };

    fetchTypes();
  </script>
</body>
</html>
